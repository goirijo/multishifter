import json
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
from mpl_toolkits.mplot3d import Axes3D
from matplotlib import cm
import argparse

def _generate_parser():
    parser = argparse.ArgumentParser(
                    formatter_class=argparse.ArgumentDefaultsHelpFormatter)
    parser.add_argument(
        "--data",
        help="json file with data to plot.",
        type=str,
        required=True)
    parser.add_argument(
        "--value",
        help="Field in the data file that should be plotted along the z-axis",
        type=str,
        required=True)

    # argcomplete.autocomplete(parser)
    return parser


def digest_sorted_surface_data(a,b,x,y,z):
    """Given sorted data with the a/b fractional points and the x/y Cartesian coordinates,
    return the x,y,z values with the correct mesh grid shape and make the z
    values relative to he minimum.

    Parameters
    ----------
    a : array
    b: array
    x: array
    y: array
    z : array

    Returns
    -------
    X,Y,Z : 2d-array,2d-array,2d-array

    """
    afloats={int(val*1e8+0.5) for val in a}
    bfloats={int(val*1e8+0.5) for val in b}

    amax=len(afloats)
    bmax=len(bfloats)

    X=x.values.reshape(amax,bmax)
    Y=y.values.reshape(amax,bmax)
    Z=(z-min(z)).values.reshape(amax,bmax)

    return X,Y,Z


def plot_gamma_surface(ax,a,b,x,y,z):
    """Given sorted data with the a/b points and the x/y Cartesian coordinates,
    plot the gamma surface. This assumes you're passing one value per
    grid point and that they're all organized the same way.

    Parameters
    ----------
    ax : mpl ax with 3d projection
    a : array
    b: array
    x: array
    y: array
    z : array

    Returns
    -------
    ax

    """
    X,Y,Z=digest_sorted_surface_data(a,b,x,y,z)

    ax.plot_surface(X,Y,Z,facecolors=cm.jet(Z/np.max(Z)),antialiased=False)
    # ax.scatter(X,Y,Z)
    ax.set_aspect('equal')

    return ax

def plot_projected_gamma_surface(ax,a,b,x,y,z):
    """Given sorted data with the a/b points and the x/y Cartesian coordinates,
    plot the gamma surface. This assumes you're passing one value per
    grid point and that they're all organized the same way.

    Parameters
    ----------
    ax : mpl ax
    a : array
    b: array
    x: array
    y: array
    z : array

    Returns
    -------
    ax

    """
    X,Y,Z=digest_sorted_surface_data(a,b,x,y,z)

    ax.pcolormesh(X,Y,Z)
    ax.set_aspect('equal')

    return ax

def main():
    parser = _generate_parser()
    args=parser.parse_args()

    filtered=pd.read_json(args.data)
    filtered=filtered.sort_values(["a_frac","b_frac"])

    fig=plt.figure()
    ax=fig.add_subplot(111,projection='3d')
    ax=plot_gamma_surface(ax,filtered["a_frac"],filtered["b_frac"],filtered["x_cart"],filtered["y_cart"],filtered[args.value])
    plt.show()

    fig=plt.figure()
    ax=fig.add_subplot(111)
    ax=plot_projected_gamma_surface(ax,filtered["a_frac"],filtered["b_frac"],filtered["x_cart"],filtered["y_cart"],filtered[args.value])
    plt.show()

if __name__=="__main__":
    main()
